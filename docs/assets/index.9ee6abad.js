var k=Object.defineProperty;var I=(i,e,r)=>e in i?k(i,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):i[e]=r;var p=(i,e,r)=>(I(i,typeof e!="symbol"?e+"":e,r),r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const t of s)if(t.type==="childList")for(const o of t.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function r(s){const t={};return s.integrity&&(t.integrity=s.integrity),s.referrerpolicy&&(t.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?t.credentials="include":s.crossorigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function n(s){if(s.ep)return;s.ep=!0;const t=r(s);fetch(s.href,t)}})();const F=(i,e,r,n)=>{const s=document.createElement(i);return s.innerText=e,r&&s.classList.add(...r.split(".").filter(t=>t)),n&&Object.entries(n).forEach(([t,o])=>{t==="children"?o.forEach(l=>s.appendChild(l)):t==="eventListeners"?Object.entries(o).forEach(([l,a])=>{s.addEventListener(l,a)}):t==="color"||t==="background"?s.style[t]=o:s[t]=o}),s};let O=0;const q=(i,e)=>{if(i.vectype==e)return i;if(i.vectype!=1)throw new Error("upcast not implemented for dtype "+i.vectype+" to "+e);return{op:"vec",srcs:Array.from({length:e},()=>i),vectype:e}},D=i=>{const e=Math.max(...i.map(r=>r.vectype));return{srcs:i.map(r=>q(r,e)),vectype:e}};class N{constructor(e){return new Proxy(this,{get(n,s){if(typeof s=="string"){const t=Array.from(s).map(o=>o.charCodeAt(0)-"x".charCodeAt(0)).filter(o=>o>=0&&o<4).map(o=>e.get(o));return f(...t)}}})}}const f=(...i)=>S(i),S=i=>{if(i instanceof Array){let e=i.map(S),r=e.reduce((s,t)=>s+t.vectype,0);if(r>4)throw new Error("gather: too many or too big vectors: "+e.map(s=>s.vectype).join(","));if(e.length==1)return e[0];let n=new u({op:"vec",srcs:e.map(s=>s.ast),vectype:r});return e.forEach(s=>s.parents.forEach(t=>n.parents.add(t))),n}return i instanceof u?i:(typeof i=="number"&&(i={op:"const",value:i,vectype:1,srcs:[]}),new u(i))};class u{constructor(e){p(this,"ast");p(this,"vectype");p(this,"parents");p(this,"onclick");p(this,"fields");this.ast=e,this.vectype=e.vectype,this.fields=new N(this),this.parents=new Set([this])}static fromVecs(e,r){const{srcs:n,vectype:s}=D(e.map(o=>o.ast));let t=new u({op:r,srcs:n,vectype:s});return e.forEach(o=>o.parents.forEach(l=>t.parents.add(l))),t}static from(e,r){const n=e.map(S);return u.fromVecs(n,r)}sin(){return u.from([this],"sin")}cos(){return u.from([this],"cos")}tan(){return u.from([this],"tan")}log(){return u.from([this],"log")}exp(){return u.from([this],"exp")}add(...e){return u.from([this,e],"add")}sub(...e){return u.from([this,e],"sub")}mul(...e){return u.from([this,e],"mul")}lt(...e){return u.from([this,e],"lt")}div(...e){return u.from([this,e],"div")}pow(e){return u.from([this,e],"pow")}atan(...e){return u.from([this,e],"atan")}clamp(e,r){return u.from([this,e,r],"clamp")}dot(e){return this.mul(e).sum()}abs(){return this.square().sqrt()}mix(e,r){let n=this.clamp(0,1);return n.mul(e).add(S(1).sub(n).mul(r))}where(e,r){return this.lt(0).mix(r,e)}get(e){if(e>=this.vectype)throw new Error("index out of bounds");let r=new u({op:"index",srcs:[this.ast],value:e,vectype:1});return this.parents.forEach(n=>r.parents.add(n)),r}length(){return this.square().sum().sqrt()}normalize(){return this.div(this.length())}reduce(e){let r=this.get(0);for(let n=1;n<this.vectype;n++)r=e(r,this.get(n));return r}gt(e){return this.lt(e).complement()}maximum(e){let r=this.lt(e);return r.mul(e).add(f(1).sub(r).mul(this))}minimum(e){return this.inv().maximum(f(e).inv()).inv()}complement(){return f(1).sub(this)}sum(){return this.reduce((e,r)=>e.add(r))}max(){return this.reduce((e,r)=>e.maximum(r))}min(){return this.reduce((e,r)=>e.minimum(r))}sqrt(){return this.pow(.5)}square(){return this.pow(2)}inv(){return this.pow(-1)}neg(){return this.mul(-1)}sub1(){return f(1).sub(this)}tanh(){let e=this.exp(),r=e.inv();return e.sub(r).div(e.add(r))}sigmoid(){return this.neg().exp().inv()}compute(e=[0,0]){return Y(this)(e)}}const M=i=>{const e=new Map,r=[];function n(s){if(e.has(s)){let a=e.get(s);return a.usecount+=1,a}const t=s.srcs.map(n),o=s.op=="varying"||s.op=="uniform"?s.name:"x"+r.length,l={ast:s,srcs:t,name:o,usecount:1};return r.push(l),e.set(s,l),l}return n(i),r},U=i=>{function e(n){return n.ast.op=="const"||n.usecount<=1?r(n):n.name}function r(n){const s=n.ast.op;if(s=="uniform"||s=="varying")return n.name;if(s=="const"){let t=n.ast.value.toString();return t.includes(".")||(t+=".0"),t}return s=="vec"?`vec${n.ast.vectype}(${n.srcs.map(t=>e(t)).join(",")})`:s=="index"?`${e(n.srcs[0])}.${["x","y","z","w"][n.ast.value]}`:s=="add"?`( ${e(n.srcs[0])} + ${e(n.srcs[1])})`:s=="sub"?`(${e(n.srcs[0])} - ${e(n.srcs[1])})`:s=="mul"?`(${e(n.srcs[0])} * ${e(n.srcs[1])})`:s=="div"?`(${e(n.srcs[0])} / ${e(n.srcs[1])})`:s=="lt"?`float(${e(n.srcs[0])} < ${e(n.srcs[1])})`:`${s}(${n.srcs.map(t=>e(t)).join(", ")})`}return i.map(n=>["uniform","varying","const"].includes(n.ast.op)||n.usecount<=1?"":`${["float","vec2","vec3","vec4"][n.ast.vectype-1]} ${n.name} = ${r(n)};
`).join("")+"gl_FragColor = "+r(i[i.length-1])+";"};class P extends u{constructor(r){const n="input"+O++;super({op:"uniform",vectype:r,srcs:[],name:n});p(this,"value");p(this,"subscribers",new Set);p(this,"name");this.name=n,this.value=Array.from({length:r},()=>0)}set(...r){if(r.length!=this.vectype)throw new Error("Input.set: wrong number of arguments");this.value=r,this.subscribers.forEach(n=>n(r))}subscribe(r){r(this.value),this.subscribers.add(r)}update(r){this.set(...r(this.value))}}const B=(i,e)=>new u({op:"varying",name:i,vectype:e,srcs:[]}),G=B("gl_FragCoord",4),$=new P(2),W=i=>{let e=M(i.ast);function r(t){return t.ast.op=="uniform"?t.name:t.ast.op=="const"?t.ast.value.toString():t.name}function n(t){const o=t.ast.op,l=t.srcs.map(r),a=c=>{let m=[];if(t.ast.vectype==1)return c(l);for(let y=0;y<t.ast.vectype;y++)m.push(c(l.map(L=>`${L}[${y}]`)));return`[${m.join(",")}]`},v=c=>a(m=>c+"("+m.join(",")+")");switch(o){case"uniform":case"varying":return t.name;case"const":return t.ast.value.toString();case"vec":return`[${l.join(",")}].flat()`;case"index":return`${n(t.srcs[0])}[${t.ast.value}]`;case"add":return a(c=>c.join(" + "));case"mul":return a(c=>c.join(" * "));case"sub":return a(c=>`(${c[0]} - ${c[1]})`);case"div":return a(c=>`(${c[0]} / ${c[1]})`);case"pow":return a(c=>`(${c[0]} ** ${c[1]})`);case"atan":return v("Math.atan2");case"sin":return v("Math.sin");case"cos":return v("Math.cos");case"tan":return v("Math.tan");case"log":return v("Math.log");case"exp":return v("Math.exp");case"clamp":return a(c=>`Math.min(Math.max(${c[0]}, ${c[1]}), ${c[2]})`);case"lt":return a(c=>`(${c[0]} < ${c[1]})`);default:throw new Error("JSCompiler: unknown op "+o)}}return"  "+e.map(t=>["uniform","varying","const"].includes(t.ast.op)?"":`const ${t.name} = ${n(t)};
  `).join("")+"return "+e[e.length-1].name},Y=i=>{let e=Array.from(i.parents).filter(n=>n.ast.op=="uniform");const r=new Function("gl_FragCoord",...Array.from(e).map(n=>n.name),W(i));return n=>r(n,...Array.from(e).map(s=>s.value))};class z{constructor(e,r){p(this,"gl");p(this,"canvas");e.vectype==1&&(e=f(e,e,e)),e.vectype==2&&(e=f(e,0)),e.vectype==3&&(e=f(e,1)),r.addEventListener("click",t=>{let o=r.clientHeight-t.offsetY,l=t.offsetX;console.log(`canvas position [${[l,o]}]`),e.parents.forEach(a=>{a.onclick&&console.log(`${a.onclick} = [${a.compute([l,o])}]`)})});const n=M(e.ast),s=Array.from(e.parents).filter(t=>t.ast.op=="uniform");{const t=r.getContext("webgl2");if(!t)throw new Error("webgl not suppported");this.gl=t,this.canvas=r;const o=(g,w)=>{const h=t.createShader(w);if(t.shaderSource(h,g),t.compileShader(h),!t.getShaderParameter(h,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(h));return h},l=`
      attribute vec2 a_position;
      void main() {
        gl_Position = vec4(a_position, 0, 1);
      }`,a=`
precision mediump float;
${s.map(g=>`uniform ${["float","vec2","vec3","vec4"][g.ast.vectype-1]} ${g.name};`).join(`
`)}



void main() {

${U(n)}

}`;console.log(a);const v=o(l,t.VERTEX_SHADER),c=o(a,t.FRAGMENT_SHADER),m=t.createProgram();if(t.attachShader(m,v),t.attachShader(m,c),t.linkProgram(m),!t.getProgramParameter(m,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(m));t.useProgram(m);const y=t.getAttribLocation(m,"a_position"),L=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,L),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),t.STATIC_DRAW),t.enableVertexAttribArray(y),t.vertexAttribPointer(y,2,t.FLOAT,!1,0,0),s.forEach(g=>{const w=g.ast,h=t.getUniformLocation(m,w.name);g.subscribe(x=>{w.vectype==1?t.uniform1f(h,...x):w.vectype==2?t.uniform2f(h,...x):w.vectype==3?t.uniform3f(h,...x):t.uniform4f(h,...x)})})}}render(){$.set(this.canvas.width,this.canvas.height),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}}document.body.appendChild(F("p","USE ARROW KEYS","",{class:"glcanvas"}));let j=[];function A(i){const e=F("canvas","","",{class:"glcanvas"});e.width=500,e.height=500,document.body.appendChild(e),j.push(new z(i,e))}let d=G.fields.xy,R=new P(1),E=new P(2),C=d.div($).mul(2);C=C.get(0);{let i=d.mul(2).sub($),e=i.div($.min()).length();d=f(i.fields.x.atan(i.fields.y.neg()).sub(E.fields.x),e.log().sub(E.fields.y)),d.onclick="P";for(let t=1;t<6;t++)d=d.add(d.fields.yx.mul(f(4,3).add(t)).sin().div(t*2)).add(R.mul(.2,.1).mul(t+.4).sin().div(t+2.3));let r=d.fields.y.add(E.fields.y).mul(.2).sigmoid();A(r);let n=d.fields.x.add(f(0,1,4)).sin().add(f(2,2,3)).normalize();n.onclick="color",A(n);let s=d.fields.y.mul(8).sin().abs().sub1().pow(4).mul(.4);A(s),A(r.mix(s.add(n),0))}{let i=d.mul(2).sub($).div($.min());i.onclick="p";for(let e=0;e<8;e++)i=i.abs().div(i.dot(i)).sub(R.mul(.2).cos().mul(.4).add(.9))}const b=new Map;document.addEventListener("keydown",i=>{i.key.startsWith("Arrow")&&i.preventDefault(),b.set(i.key,!0)});document.addEventListener("keyup",i=>b.set(i.key,!1));function T(i){var s,t,o,l;let e=0;R.update(a=>(i*=.001,e=i-a[0],[i]));let r=((s=b.get("ArrowRight"))!=null&&s?1:0)-((t=b.get("ArrowLeft"))!=null&&t?1:0),n=((o=b.get("ArrowUp"))!=null&&o?1:0)-((l=b.get("ArrowDown"))!=null&&l?1:0);E.update(a=>[a[0]+e*r*1,a[1]+e*n]),j.forEach(a=>a.render()),requestAnimationFrame(T)}T(0);
