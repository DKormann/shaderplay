var q=Object.defineProperty;var O=(i,e,r)=>e in i?q(i,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):i[e]=r;var g=(i,e,r)=>(O(i,typeof e!="symbol"?e+"":e,r),r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&t(s)}).observe(document,{childList:!0,subtree:!0});function r(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerpolicy&&(o.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?o.credentials="include":n.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function t(n){if(n.ep)return;n.ep=!0;const o=r(n);fetch(n.href,o)}})();const N=(i,e,r,t)=>{const n=document.createElement(i);return n.innerText=e,r&&n.classList.add(...r.split(".").filter(o=>o)),t&&Object.entries(t).forEach(([o,s])=>{o==="children"?s.forEach(u=>n.appendChild(u)):o==="eventListeners"?Object.entries(s).forEach(([u,a])=>{n.addEventListener(u,a)}):o==="color"||o==="background"?n.style[o]=s:n[o]=s}),n};let B=0;const D=(i,e)=>{if(i.vectype==e)return i;if(i.vectype!=1)throw new Error("upcast not implemented for dtype "+i.vectype+" to "+e);return{op:"vec",srcs:Array.from({length:e},()=>i),vectype:e}},U=i=>{const e=Math.max(...i.map(r=>r.vectype));return{srcs:i.map(r=>D(r,e)),vectype:e}};class z{constructor(e){return new Proxy(this,{get(t,n){if(typeof n=="string"){const o=Array.from(n).map(s=>s.charCodeAt(0)-"x".charCodeAt(0)).filter(s=>s>=0&&s<4).map(s=>e.get(s));return h(...o)}}})}}const h=(...i)=>S(i),S=i=>{if(i instanceof Array){let e=i.map(S),r=e.reduce((n,o)=>n+o.vectype,0);if(r>4)throw new Error("gather: too many or too big vectors: "+e.map(n=>n.vectype).join(","));if(e.length==1)return e[0];let t=new l({op:"vec",srcs:e.map(n=>n.ast),vectype:r});return e.forEach(n=>n.parents.forEach(o=>t.parents.add(o))),t}return i instanceof l?i:(typeof i=="number"&&(i={op:"const",value:i,vectype:1,srcs:[]}),new l(i))};class l{constructor(e){g(this,"ast");g(this,"vectype");g(this,"parents");g(this,"onclick");g(this,"fields");this.ast=e,this.vectype=e.vectype,this.fields=new z(this),this.parents=new Set([this])}static fromVecs(e,r){const{srcs:t,vectype:n}=U(e.map(s=>s.ast));let o=new l({op:r,srcs:t,vectype:n});return e.forEach(s=>s.parents.forEach(u=>o.parents.add(u))),o}static from(e,r){const t=e.map(S);return l.fromVecs(t,r)}sin(){return l.from([this],"sin")}cos(){return l.from([this],"cos")}tan(){return l.from([this],"tan")}log(){return l.from([this],"log")}exp(){return l.from([this],"exp")}add(...e){return l.from([this,e],"add")}sub(...e){return l.from([this,e],"sub")}mul(...e){return l.from([this,e],"mul")}lt(...e){return l.from([this,e],"lt")}div(...e){return l.from([this,e],"div")}mod(...e){return l.from([this,e],"mod")}pow(e){return l.from([this,e],"pow")}atan(...e){return l.from([this,e],"atan")}clamp(e,r){return l.from([this,e,r],"clamp")}dot(e){return this.mul(e).sum()}abs(){return this.square().sqrt()}mix(e,r){let t=this.clamp(0,1);return t.mul(e).add(S(1).sub(t).mul(r))}where(e,r){return this.lt(0).mix(r,e)}get(e){if(e>=this.vectype)throw new Error("index out of bounds");let r=new l({op:"index",srcs:[this.ast],value:e,vectype:1});return this.parents.forEach(t=>r.parents.add(t)),r}length(){return this.square().sum().sqrt()}normalize(){return this.div(this.length())}reduce(e){let r=this.get(0);for(let t=1;t<this.vectype;t++)r=e(r,this.get(t));return r}gt(e){return this.lt(e).complement()}maximum(e){let r=this.lt(e);return r.mul(e).add(h(1).sub(r).mul(this))}minimum(e){return this.inv().maximum(h(e).inv()).inv()}complement(){return h(1).sub(this)}sum(){return this.reduce((e,r)=>e.add(r))}prod(){return this.reduce((e,r)=>e.mul(r))}max(){return this.reduce((e,r)=>e.maximum(r))}min(){return this.reduce((e,r)=>e.minimum(r))}sqrt(){return this.pow(.5)}square(){return this.pow(2)}inv(){return this.pow(-1)}neg(){return this.mul(-1)}sub1(){return h(1).sub(this)}tanh(){let e=this.exp(),r=e.inv();return e.sub(r).div(e.add(r))}atanh(){return this.add(1).div(this.sub1()).log().mul(.5)}sigmoid(){return this.neg().exp().add(1).inv()}compute(e=[0,0]){return X(this)(e)}frac(){return this.mod(1)}floor(){return this.sub(this.frac())}steps(e){return this.mul(e).floor().div(e)}}const C=i=>{const e=new Map,r=[];function t(n){if(e.has(n)){let a=e.get(n);return a.usecount+=1,a}const o=n.srcs.map(t),s=n.op=="varying"||n.op=="uniform"?n.name:"x"+r.length,u={ast:n,srcs:o,name:s,usecount:1};return r.push(u),e.set(n,u),u}return t(i),r},G=i=>{function e(t){return t.ast.op=="const"||t.usecount<=1?r(t):t.name}function r(t){const n=t.ast.op;if(n=="uniform"||n=="varying")return t.name;if(n=="const"){let u=t.ast.value.toString();return u.includes(".")||(u+=".0"),u}const o=["float","vec2","vec3","vec4"][t.ast.vectype-1];if(n=="vec")return`${o}(${t.srcs.map(u=>e(u)).join(",")})`;if(n=="index")return`${e(t.srcs[0])}.${["x","y","z","w"][t.ast.value]}`;if(n=="add")return`(${e(t.srcs[0])} + ${e(t.srcs[1])})`;if(n=="sub")return`(${e(t.srcs[0])} - ${e(t.srcs[1])})`;if(n=="mul")return`(${e(t.srcs[0])} * ${e(t.srcs[1])})`;if(n=="div")return`(${e(t.srcs[0])} / ${e(t.srcs[1])})`;if(n=="mod")return`mod(${e(t.srcs[0])}, ${e(t.srcs[1])})`;if(n=="lt")return s((u,a)=>`${u} < ${a} ? 1.0 : 0.0`);function s(u){const[a,f]=t.srcs.map(e);if(t.srcs[0].ast.vectype==1)return`(${u(a,f)})`;const c=[];for(let v=0;v<t.srcs[0].ast.vectype;v++){const m=["x","y","z","w"][v];c.push(`${u(`${a}.${m}`,`${f}.${m}`)}`)}return`${o}(${c.join(", ")})`}return`${n}(${t.srcs.map(u=>e(u)).join(", ")})`}return i.map(t=>["uniform","varying","const"].includes(t.ast.op)||t.usecount<=1?"":`${["float","vec2","vec3","vec4"][t.ast.vectype-1]} ${t.name} = ${r(t)};
`).join("")+"gl_FragColor = "+r(i[i.length-1])+";"};class M extends l{constructor(r){const t="input"+B++;super({op:"uniform",vectype:r,srcs:[],name:t});g(this,"value");g(this,"subscribers",new Set);g(this,"name");this.name=t,this.value=Array.from({length:r},()=>0)}set(...r){if(r.length!=this.vectype)throw new Error("Input.set: wrong number of arguments");this.value=r,this.subscribers.forEach(t=>t(r))}subscribe(r){r(this.value),this.subscribers.add(r)}update(r){this.set(...r(this.value))}}const H=(i,e)=>new l({op:"varying",name:i,vectype:e,srcs:[]}),W=H("gl_FragCoord",4),L=new M(2),J=i=>{let e=C(i.ast);function r(o){return o.ast.op=="uniform"?o.name:o.ast.op=="const"?o.ast.value.toString():o.name}function t(o){const s=o.ast.op,u=o.srcs.map(r),a=c=>{let v=[];if(o.ast.vectype==1)return c(u);for(let m=0;m<o.ast.vectype;m++)v.push(c(u.map(p=>`${p}[${m}]`)));return`[${v.join(",")}]`},f=c=>a(v=>c+"("+v.join(",")+")");switch(s){case"uniform":case"varying":return o.name;case"const":return o.ast.value.toString();case"vec":return`[${u.join(",")}].flat()`;case"index":return`${t(o.srcs[0])}[${o.ast.value}]`;case"add":return a(c=>c.join(" + "));case"mul":return a(c=>c.join(" * "));case"sub":return a(c=>`(${c[0]} - ${c[1]})`);case"div":return a(c=>`(${c[0]} / ${c[1]})`);case"mod":return a(c=>`(${c[0]} % ${c[1]})`);case"pow":return a(c=>`(${c[0]} ** ${c[1]})`);case"lt":return a(c=>`(${c[0]} < ${c[1]} ? 1. : 0.)`);case"atan":return f("Math.atan2");case"sin":return f("Math.sin");case"cos":return f("Math.cos");case"tan":return f("Math.tan");case"log":return f("Math.log");case"exp":return f("Math.exp");case"clamp":return a(c=>`Math.min(Math.max(${c[0]}, ${c[1]}), ${c[2]})`);default:throw new Error("JSCompiler: unknown op "+s)}}return"  "+e.map(o=>["uniform","varying","const"].includes(o.ast.op)?"":`const ${o.name} = ${t(o)};
  `).join("")+"return "+e[e.length-1].name},X=i=>{let e=Array.from(i.parents).filter(t=>t.ast.op=="uniform");const r=new Function("gl_FragCoord",...Array.from(e).map(t=>t.name),J(i));return t=>r(t,...Array.from(e).map(n=>n.value))};class Y{constructor(e,r){g(this,"gl");g(this,"canvas");let t=h(...e);t.vectype==1&&(t=h(t,t,t)),t.vectype==2&&(t=h(t,0)),t.vectype==3&&(t=h(t,1)),r.addEventListener("click",s=>{let u=r.clientHeight-s.offsetY,a=s.offsetX;console.log(`canvas position [${[a,u]}]`),t.parents.forEach(f=>{f.onclick&&console.log(`${f.onclick} = [${f.compute([a,u])}]`)})});const n=C(t.ast),o=Array.from(t.parents).filter(s=>s.ast.op=="uniform");{const s=r.getContext("webgl2");if(!s)throw new Error("webgl not suppported");this.gl=s,this.canvas=r;const u=(b,$)=>{const y=s.createShader($);if(s.shaderSource(y,b),s.compileShader(y),!s.getShaderParameter(y,s.COMPILE_STATUS))throw new Error(s.getShaderInfoLog(y));return y},a=`
      attribute vec2 a_position;
      void main() {
        gl_Position = vec4(a_position, 0, 1);
      }`,f=`
precision mediump float;
${o.map(b=>`uniform ${["float","vec2","vec3","vec4"][b.ast.vectype-1]} ${b.name};`).join(`
`)}



void main() {

${G(n)}

}`,c=u(a,s.VERTEX_SHADER),v=u(f,s.FRAGMENT_SHADER),m=s.createProgram();if(s.attachShader(m,c),s.attachShader(m,v),s.linkProgram(m),!s.getProgramParameter(m,s.LINK_STATUS))throw new Error(s.getProgramInfoLog(m));s.useProgram(m);const p=s.getAttribLocation(m,"a_position"),x=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,x),s.bufferData(s.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),s.STATIC_DRAW),s.enableVertexAttribArray(p),s.vertexAttribPointer(p,2,s.FLOAT,!1,0,0),o.forEach(b=>{const $=b.ast,y=s.getUniformLocation(m,$.name);b.subscribe(A=>{$.vectype==1?s.uniform1f(y,...A):$.vectype==2?s.uniform2f(y,...A):$.vectype==3?s.uniform3f(y,...A):s.uniform4f(y,...A)})})}}render(){L.set(this.canvas.width,this.canvas.height),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}}function F(...i){let e="";const r=N("canvas","","",{class:"glcanvas"});r.width=j?window.innerWidth:500,r.height=j?window.innerHeight:500,r.addEventListener("touchstart",t=>{e=t.touches[0].clientX<r.width/2?"ArrowLeft":"ArrowRight",w.set(e,!0)}),r.addEventListener("touchend",t=>{w.set(e,!1)}),document.body.appendChild(r),T.push(new Y(i,r))}let T=[];const j=!!navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/);let d=W.fields.xy,R=new M(1),E=new M(2),k=d.div(L).mul(2);k=k.get(0);const K=i=>i.add(2.4).mul(435.23).sin().mul(34).abs().frac();{let i=d.mul(2).sub(L).div(L.min());d=h(i.fields.x.atan(i.fields.y.neg()),i.length().log());let e=d.fields.x.div(3.1415*2);for(let p=0;p<6;p++){let x=1.8**p;e=e.add(d.fields.y.mul(x*.2).frac().sub(.5).abs().div(x*2))}let r=d.add(0,.3).div(.2),t=r.length(),n=t.sub1().mul(100).sigmoid(),o=t.square().mul(2).sub(1).clamp(-.999,.999).atanh().neg(),s=r.fields.x.atan(r.fields.y);o.onclick="refy",d=n.mix(h(s,o),d),d=d.add(E);const u=32;let a=h(e.mod(1),d.fields.y.sub(R));a=a.mul(u,.5).add(0,a.fields.x.steps(u).mul(5.34)),a=a.abs().frac().mul(2).sub(1).abs().sub1().mul(1,2).clamp(0,1).square().prod().mul(K(a.floor().mul(12.3,4.1).sum()).lt(.1));let f=0;for(let p=1;p<6;p++)d=d.add(d.fields.yx.mul(h(4,3).add(p)).sin().div(p*2)).add(R.mul(.2,.1).mul(p+.4).sin().div(p+2.3));let c=d.fields.x.add(h(0,1,4)).sin().add(h(2,2,3)).normalize();d.fields.y.sub(E.fields.y).mul(8).sin().abs().sub1().pow(4).mul(.4);let v=d.fields.y.sub(E.fields.y).add(1).sigmoid();v.onclick="dim";let m=a.mix([1,.2,.2],c.mul(v));F(m),F(n.mix(f,m))}const w=new Map;document.addEventListener("keydown",i=>{i.key.startsWith("Arrow")&&i.preventDefault(),w.set(i.key,!0)});document.addEventListener("keyup",i=>w.set(i.key,!1));const P=Math.PI*2;function I(i){var n,o,s,u;let e=0;R.update(a=>(i*=.001,e=i-a[0],[i]));let r=((n=w.get("ArrowRight"))!=null&&n?1:0)-((o=w.get("ArrowLeft"))!=null&&o?1:0),t=((s=w.get("ArrowDown"))!=null&&s?1:0)-((u=w.get("ArrowUp"))!=null&&u?1:0);E.update(a=>[((a[0]+e*r*1)%P+P)%P,a[1]+e*t]),T.forEach(a=>a.render()),requestAnimationFrame(I)}I(0);
