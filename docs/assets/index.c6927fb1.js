var C=Object.defineProperty;var N=(n,t,s)=>t in n?C(n,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[t]=s;var f=(n,t,s)=>(N(n,typeof t!="symbol"?t+"":t,s),s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))r(e);new MutationObserver(e=>{for(const i of e)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function s(e){const i={};return e.integrity&&(i.integrity=e.integrity),e.referrerpolicy&&(i.referrerPolicy=e.referrerpolicy),e.crossorigin==="use-credentials"?i.credentials="include":e.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(e){if(e.ep)return;e.ep=!0;const i=s(e);fetch(e.href,i)}})();const $=(n,t,s,r)=>{const e=document.createElement(n);return e.innerText=t,s&&e.classList.add(...s.split(".").filter(i=>i)),r&&Object.entries(r).forEach(([i,c])=>{i==="children"?c.forEach(u=>e.appendChild(u)):i==="eventListeners"?Object.entries(c).forEach(([u,h])=>{e.addEventListener(u,h)}):i==="color"||i==="background"?e.style[i]=c:e[i]=c}),e};let U=0;const x=(n,t=null)=>{if(t==null&&(t=R(n)),typeof n=="number"&&(n={op:"const",value:n,vectype:1,srcs:[]}),n.vectype==t)return n;if(n.vectype!=1)throw new Error("upcast not implemented for dtype "+t);if(typeof n.op!="string")throw new Error("upcast not implemented for "+n);return{op:"vec",srcs:Array.from({length:t},()=>n),vectype:t}},R=n=>typeof n=="number"?1:n.vectype,j=n=>{const t=Math.max(...n.map(R));return{srcs:n.map(s=>x(s,t)),vectype:t}},q=n=>n instanceof o?n.ast:x(n);class o{constructor(t,s="vec"){f(this,"ast");f(this,"vectype");f(this,"inputs",new Set);t instanceof Array||(t=[t]);let r=t.map(q);if(t.forEach(e=>{e instanceof o&&e.inputs.forEach(i=>this.inputs.add(i))}),s=="vec")if(r.length==1)this.ast=r[0];else{let e=r.reduce((i,c)=>i+c.vectype,0);this.ast={op:s,srcs:r,vectype:e}}else{let{srcs:e,vectype:i}=j(r);this.ast={op:s,srcs:e,vectype:i}}if(this.vectype=this.ast.vectype,isNaN(this.ast.vectype))throw new Error("vector must have 1,2,3 or 4 components");if(this.ast.vectype==null)throw new Error("vector must have 1,2,3 or 4 components");if(typeof this.ast.op!="string")throw new Error("wrong ast type")}sin(){return new o([this],"sin")}cos(){return new o([this],"cos")}tan(){return new o([this],"tan")}log(){return new o([this],"log")}exp(){return new o([this],"exp")}add(t){return new o([this,t],"add")}sub(t){return new o([this,t],"sub")}mul(t){return new o([this,t],"mul")}div(t){return new o([this,t],"div")}pow(t){return new o([this,t],"pow")}atan(t){return new o([this,t],"atan")}clamp(t,s){return new o([this,t,s],"clamp")}static fromAst(t,s){let r=new o(t);return s.forEach(e=>r.inputs.add(e)),r}getter(t){if(t>=this.vectype)throw new Error("index out of bounds");return o.fromAst({op:"index",srcs:[this.ast],value:t,vectype:1},this.inputs)}x(){return this.getter(0)}y(){return this.getter(1)}z(){return this.getter(2)}w(){return this.getter(3)}length(){return this.square().sum().sqrt()}normalize(){return this.div(this.length())}sum(){let t=this.getter(0);for(let s=1;s<this.vectype;s++)t=t.add(this.getter(s));return t}sqrt(){return this.pow(.5)}square(){return this.pow(2)}inv(){return this.pow(-1)}tanh(){return this.div(this.add(1).exp().add(1).exp().inv())}}const M=n=>{const t=new Map,s=[];function r(e){if(t.has(e)){let h=t.get(e);return h.usecount+=1,h}const i=e.srcs.map(r),c=e.op=="varying"||e.op=="uniform"?e.name:"x"+s.length,u={ast:e,srcs:i,name:c,usecount:1};return s.push(u),t.set(e,u),u}return r(n),s},B=n=>{function t(r){return r.ast.op=="const"||r.usecount<=1?s(r):r.name}function s(r){const e=r.ast.op;if(e=="uniform"||e=="varying")return r.name;if(e=="const"){let i=r.ast.value.toString();return i.includes(".")||(i+=".0"),i}return e=="vec"?`vec${r.ast.vectype}(${r.srcs.map(i=>t(i)).join(",")})`:e=="index"?`${t(r.srcs[0])}.${["x","y","z","w"][r.ast.value]}`:e=="add"?`( ${t(r.srcs[0])} + ${t(r.srcs[1])})`:e=="sub"?`(${t(r.srcs[0])} - ${t(r.srcs[1])})`:e=="mul"?`(${t(r.srcs[0])} * ${t(r.srcs[1])})`:e=="div"?`(${t(r.srcs[0])} / ${t(r.srcs[1])})`:`${e}(${r.srcs.map(i=>t(i)).join(", ")})`}return n.map(r=>["uniform","varying","const"].includes(r.ast.op)||r.usecount==1?"":`${["float","vec2","vec3","vec4"][r.ast.vectype-1]} ${r.name} = ${s(r)};
`).join("")+"gl_FragColor = "+s(n[n.length-1])};class w extends o{constructor(s){const r="input"+U++;super({op:"uniform",vectype:s,srcs:[],name:r});f(this,"value");f(this,"subscribers",new Set);f(this,"name");this.inputs.add(this),this.name=r,this.value=Array.from({length:s},()=>0)}set(...s){if(s.length!=this.vectype)throw new Error("Input.set: wrong number of arguments");this.value=s,this.subscribers.forEach(r=>r(s))}subscribe(s){s(this.value),this.subscribers.add(s)}get(){return this.value}update(s){this.set(s(this.get))}}const D=(n,t)=>new o({op:"varying",name:n,vectype:t,srcs:[]}),y=D("pos",2);new w(1);class Y{constructor(t,s){f(this,"gl");if(t.vectype<3)throw new Error("graph must result in vec3 got "+t.vectype);t.vectype==3&&(t=new o([t,1]));const r=Array.from(t.inputs);{const e=s.getContext("webgl2");if(!e)throw new Error("webgl not suppported");this.gl=e;const i=(p,d)=>{const a=e.createShader(d);if(e.shaderSource(a,p),e.compileShader(a),!e.getShaderParameter(a,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(a));return a},c=`
      attribute vec2 a_position;
      varying vec2 pos;
      void main() {
        pos = a_position;
        gl_Position = vec4(a_position, 0, 1);
      }`,u=`
precision mediump float;
varying vec2 pos;
${r.map(p=>`uniform ${["float","vec2","vec3","vec4"][p.ast.vectype-1]} ${p.name};`).join(`
`)}

void main() {

${B(M(t.ast))};

}`,h=i(c,e.VERTEX_SHADER),I=i(u,e.FRAGMENT_SHADER),l=e.createProgram();if(e.attachShader(l,h),e.attachShader(l,I),e.linkProgram(l),!e.getProgramParameter(l,e.LINK_STATUS))throw new Error(e.getProgramInfoLog(l));e.useProgram(l);const E=e.getAttribLocation(l,"a_position"),O=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,O),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),e.STATIC_DRAW),e.enableVertexAttribArray(E),e.vertexAttribPointer(E,2,e.FLOAT,!1,0,0),r.forEach(p=>{const d=p.ast,a=e.getUniformLocation(l,d.name);p.subscribe(g=>{d.vectype==1?e.uniform1f(a,...g):d.vectype==2?e.uniform2f(a,...g):d.vectype==3?e.uniform3f(a,...g):e.uniform4f(a,...g)})})}}render(){this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}}document.body.appendChild($("p","USE ARROW KEYS","",{class:"glcanvas"}));function k(n){const t=$("canvas","","",{class:"glcanvas"});return t.width=500,t.height=500,document.body.appendChild(t),new Y(n,t)}let m=new w(1),P=new w(1),T=new w(1),z=y.length(),G=y.x().atan(y.y()).add(P);m.mul(5).sin().mul(.2);let K=G.mul(10).sin(),W=z.log().sub(T).mul(10).sin(),H=K.mul(W),b=new o([m,m,m.add(.5)]);b=b.sin();let X=k(b.mul(H));const v=new Map;document.addEventListener("keydown",n=>{v.set(n.key,!0)});document.addEventListener("keyup",n=>{v.set(n.key,!1)});let A=0,S=0,L=0;function F(n){var e,i,c;n=n*.001;let t=n-A;A=n;let s=((e=v.get("ArrowRight"))!=null&&e?1:0)-((i=v.get("ArrowLeft"))!=null&&i?1:0),r=(c=v.get("ArrowUp"))!=null&&c?1:0;r+=0,S+=t*s*2,L+=t*r,P.set(S),T.set(L),m.set(n),X.render(),requestAnimationFrame(F)}F(0);
