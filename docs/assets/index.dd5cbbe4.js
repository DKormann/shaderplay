var G=Object.defineProperty;var H=(t,e,o)=>e in t?G(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o;var b=(t,e,o)=>(H(t,typeof e!="symbol"?e+"":e,o),o);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function o(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerpolicy&&(r.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?r.credentials="include":n.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=o(n);fetch(n.href,r)}})();const K=(t,e,o,s)=>{const n=document.createElement(t);return n.innerText=e,o&&n.classList.add(...o.split(".").filter(r=>r)),s&&Object.entries(s).forEach(([r,c])=>{r==="children"?c.forEach(u=>n.appendChild(u)):r==="eventListeners"?Object.entries(c).forEach(([u,f])=>{n.addEventListener(u,f)}):r==="color"||r==="background"?n.style[r]=c:n[r]=c}),n},P=(t,e=null)=>{if(e==null&&(e=v(t)),typeof t=="number"&&(t={op:"const",value:t,vectype:1,srcs:[]}),t.vectype==e)return t;if(t.vectype!=1)throw new Error("upcast not implemented for dtype "+e);return{op:"vec",srcs:Array.from({length:e},()=>t),vectype:e}},v=t=>typeof t=="number"?1:t.vectype,E=t=>{const e=Math.max(...t.map(v));return{srcs:t.map(o=>P(o,e)),vectype:e}},w=t=>e=>({op:t,...E([e])}),g=t=>(e,o)=>({op:t,...E([e,o])}),W=t=>(e,o,s)=>({op:t,...E([e,o,s])}),Y=(...t)=>{let e=t.map(s=>P(s));if(e.length==1)return e[0];let o=e.reduce((s,n)=>s+v(n),0);if(isNaN(o))throw new Error("vec can only have 4 arguments");if(o>4)throw new Error("vec can only have 4 arguments");return{op:"vec",srcs:e,vectype:o}},d=(t,e)=>{if(v(e)<=t)throw new Error(`index ${t} out of bounds for vec size ${v(e)}`);return{op:"index",srcs:E([e]).srcs,value:t,vectype:1}},X=w("sin"),J=w("cos"),Q=w("tan"),Z=w("log"),R=w("exp"),A=g("add"),T=g("sub"),$=g("mul"),S=g("div"),F=g("pow"),k=g("atan"),_=W("clamp"),x=t=>F(t,.5),N=t=>{let e=d(0,t);for(let o=1;o<v(t);o++)e=A(e,d(o,t));return e},I=t=>x(N($(t,t))),V=t=>S(t,I(t)),ee=t=>T(S(2,A(1,R($(t,-2)))),1),l=t=>t instanceof i?t.ast:t;class i{constructor(...e){b(this,"ast");b(this,"vectype");if(this.ast=Y(...e.map(l)),isNaN(this.ast.vectype))throw new Error("vector must have 1,2,3 or 4 components");if(this.ast.vectype==null)throw new Error("vector must have 1,2,3 or 4 components");this.vectype=this.ast.vectype}sin(){return new i(X(this.ast))}cos(){return new i(J(this.ast))}tan(){return new i(Q(this.ast))}log(){return new i(Z(this.ast))}exp(){return new i(R(this.ast))}add(e){return new i(A(this.ast,l(e)))}sub(e){return new i(T(this.ast,l(e)))}mul(e){return new i($(this.ast,l(e)))}div(e){return new i(S(this.ast,l(e)))}pow(e){return new i(F(this.ast,l(e)))}atan(e){return new i(k(this.ast,l(e)))}clamp(e,o){return new i(_(this.ast,l(e),l(o)))}x(){return new i(d(0,this.ast))}y(){return new i(d(1,this.ast))}z(){return new i(d(2,this.ast))}w(){return new i(d(3,this.ast))}length(){return new i(I(this.ast))}normalize(){return new i(V(this.ast))}sum(){return new i(N(this.ast))}sqrt(){return new i(x(this.ast))}tanh(){return new i(ee(this.ast))}}const O=t=>{const e=new Map,o=[];function s(n){if(e.has(n)){let f=e.get(n);return f.usecount+=1,f}const r=n.srcs.map(s),c=n.op=="varying"?n.name:"x"+o.length,u={ast:n,srcs:r,name:c,usecount:1};return o.push(u),e.set(n,u),u}return s(t),o},C=t=>{function e(s){return s.usecount>1?s.name:o(s)}function o(s){const n=s.ast.op;if(n=="uniform"||n=="varying")return s.name;if(n=="const"){let r=s.ast.value.toString();return r.includes(".")||(r+=".0"),r}return n=="vec"?`vec${s.ast.vectype}(${s.srcs.map(r=>e(r)).join(",")})`:n=="index"?`${e(s.srcs[0])}.${["x","y","z","w"][s.ast.value]}`:n=="add"?`( ${e(s.srcs[0])} + ${e(s.srcs[1])})`:n=="sub"?`(${e(s.srcs[0])} - ${e(s.srcs[1])})`:n=="mul"?`(${e(s.srcs[0])} * ${e(s.srcs[1])})`:n=="div"?`(${e(s.srcs[0])} / ${e(s.srcs[1])})`:`${n}(${s.srcs.map(r=>e(r)).join(", ")})`}return t.map(s=>["uniform","varying","const"].includes(s.ast.op)||s.usecount==1?"":`${["float","vec2","vec3","vec4"][s.ast.vectype-1]} ${s.name} = ${o(s)};
`).join("")+"gl_FragColor = "+o(t[t.length-1])};class j extends i{constructor(e){super({op:"uniform",vectype:e,srcs:[],setValue:(...o)=>{}})}setValue(...e){this.ast.setValue(...e)}}const te=(t,e)=>new i({op:"varying",name:t,vectype:e,srcs:[]}),z=te("pos",2),re=new j(1);let ne=new i(1,2,3,4),se=ne.sum().add(z).add(re);console.log(C(O(se.ast)));class oe{constructor(e,o){b(this,"gl");if(e.vectype<3)throw new Error("graph must result in vec3 got "+e.vectype);e.vectype==3&&(e=new i(e,1));const s=O(e.ast);console.log(s);const n=s.filter(r=>r.ast.op=="uniform");{const r=o.getContext("webgl2");if(console.log(r),!r)throw new Error("webgl not suppported");this.gl=r;const c=(p,h)=>{const a=r.createShader(h);if(r.shaderSource(a,p),r.compileShader(a),!r.getShaderParameter(a,r.COMPILE_STATUS))throw new Error(r.getShaderInfoLog(a));return a},u=`
      attribute vec2 a_position;
      varying vec2 pos;
      void main() {
        pos = a_position;
        gl_Position = vec4(a_position, 0, 1);
      }`,f=`
precision mediump float;
varying vec2 pos;
${n.map(p=>`uniform ${["float","vec2","vec3","vec4"][p.ast.vectype-1]} ${p.name};`).join(`
`)}

void main() {
  ${C(s)};

}`;console.log(f),console.log("frag shader compiled"),console.log(f);const q=c(u,r.VERTEX_SHADER),B=c(f,r.FRAGMENT_SHADER),m=r.createProgram();if(r.attachShader(m,q),r.attachShader(m,B),r.linkProgram(m),!r.getProgramParameter(m,r.LINK_STATUS))throw new Error(r.getProgramInfoLog(m));r.useProgram(m);const L=r.getAttribLocation(m,"a_position"),D=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,D),r.bufferData(r.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),r.STATIC_DRAW),r.enableVertexAttribArray(L),r.vertexAttribPointer(L,2,r.FLOAT,!1,0,0),n.forEach(p=>{const h=p.ast,a=r.getUniformLocation(m,p.name);h.setValue=(...y)=>{h.vectype==1?r.uniform1f(a,...y):h.vectype==2?r.uniform2f(a,...y):h.vectype==3?r.uniform3f(a,...y):r.uniform4f(a,...y)}})}}render(){this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}}function ie(t){const e=K("canvas","","",{class:"glcanvas"});return e.width=500,e.height=500,document.body.appendChild(e),new oe(t,e)}let M=new j(1),ce=M.mul(5).sin().mul(.2).add(5),ae=z.length().mul(10).sub(ce).tanh(),ue=new i(0,ae,0),le=ie(ue);function U(t){M.setValue(t*.001),le.render(),requestAnimationFrame(U)}U(0);
