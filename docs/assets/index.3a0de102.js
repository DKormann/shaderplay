var H=Object.defineProperty;var K=(n,e,r)=>e in n?H(n,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[e]=r;var i=(n,e,r)=>(K(n,typeof e!="symbol"?e+"":e,r),r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))t(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&t(l)}).observe(document,{childList:!0,subtree:!0});function r(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerpolicy&&(s.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?s.credentials="include":o.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(o){if(o.ep)return;o.ep=!0;const s=r(o);fetch(o.href,s)}})();const Y=(n,e,r,t)=>{const o=document.createElement(n);return o.innerText=e,r&&o.classList.add(...r.split(".").filter(s=>s)),t&&Object.entries(t).forEach(([s,l])=>{s==="children"?l.forEach(a=>o.appendChild(a)):s==="eventListeners"?Object.entries(l).forEach(([a,d])=>{o.addEventListener(a,d)}):s==="color"||s==="background"?o.style[s]=l:o[s]=l}),o};let O=0;class v{constructor(e){i(this,"size");this.size=e}toString(){return this.size==1?"float":"vec"+this.size}choose(...e){return e[this.size-1]}eq(e){return this.size==e.size}}const p=new v(1),z=new v(2),N=new v(3),U=new v(4);class B{constructor(e=null,r=p){i(this,"name");i(this,"dtype");i(this,"add",this.app_binary(b("+")));i(this,"sub",this.app_binary(b("-")));i(this,"mul",this.app_binary(b("*")));i(this,"div",this.app_binary(b("/")));i(this,"sin",this.app_unary(S("sin")));i(this,"cos",this.app_unary(S("cos")));i(this,"log",this.app_unary(S("log")));i(this,"pow",this.app_binary(V("pow")));i(this,"atan",this.app_binary(V("atan")));i(this,"clamp",(e,r)=>new y([this,e,r],J("clamp")));i(this,"x",()=>_("x",this));i(this,"y",()=>_("y",this));i(this,"z",()=>_("z",this));i(this,"w",()=>_("w",this));e==null&&(e="x"+String(O),O+=1),this.name=e,this.dtype=r}gen(){return this.name}compile(e){e.varmap.has(this.name)||e.varmap.set(this.name,this)}toString(){return"AST"}app_binary(e){return r=>new y([this,r],e)}app_unary(e){return()=>new y([this],e)}}const W=n=>new f(-1,(...e)=>`${n}(${e.map(r=>r.name).join(",")})`),g=n=>{console.log(n);let e=n.map(o=>typeof o=="number"?X(o,p):o).reduce((o,s)=>o+s.dtype.size,0);if(e>4)throw new Error("too many args");const r=[p,z,N,U][e-1],t=new y(n,W(r));return t.dtype=r,t},X=(n,e=p)=>{if(typeof n=="number"&&(n=new A(n)),n.dtype==e)return n;if(n.dtype!=p)throw new Error("cant upcast:"+n.dtype+"->"+e);return g(Array.from({length:e.size},(r,t)=>n))};class f{constructor(e,r){i(this,"arity");i(this,"gen");this.arity=e,this.gen=(...t)=>r(...t.map(o=>typeof o=="number"?new A(o):o))}toString(){return this.gen(...Array.from({length:this.arity},(e,r)=>new A(r)))}}function b(n){return new f(2,(e,r)=>`${e.name} ${n} ${r.name}`)}function S(n){return new f(1,e=>`${n}(${e.name})`)}function V(n){return new f(2,(e,r)=>`${n}(${e.name}, ${r.name})`)}function J(n){return new f(3,(e,r,t)=>`${n}(${e.name}, ${r.name}, ${t.name})`)}function _(n,e){if(["x","y","z","w"].indexOf(n)>e.dtype.size-1)throw new Error("field out of bounds");const t=new f(1,s=>`${s.name}.${n}`),o=new y([e],t);return o.dtype=p,o}class A extends B{constructor(r){let t=`${r}`;t.includes(".")||(t+=".");super(t,p);i(this,"value");this.value=r*1}compile(r){}gen(){return this.name}}class y extends B{constructor(r,t,o=null,s=null){let l=r.map(a=>typeof a=="number"?new A(a):a);s==null&&(s=l.map(a=>a.dtype).reduce((a,d)=>a.size>d.size?a:d,p));super(o,s);i(this,"srcs");i(this,"op");this.srcs=l,this.op=t}gen(){return this.op.gen(...this.srcs)}compile(r){this.srcs.forEach(t=>t.compile(r)),super.compile(r)}}class R extends y{constructor(r=null,t=p){super([],new f(0,()=>"name"),r,t);i(this,"setValue",r=>{})}compile(r){r.uniforms.set(this.name,this)}}class Q extends R{compile(e){}}const x=new Q("pos",z);class Z{constructor(e,r){i(this,"varmap",new Map);i(this,"uniforms",new Map);i(this,"graph");i(this,"gl");if(e.dtype!=U)throw`frag shader must result in vec4 got ${e.dtype}`;e.compile(this),this.varmap.delete(e.name),this.graph=e,console.log(e);{const t=r.getContext("webgl");if(!t)throw new Error("webgl not suppported");this.gl=t;const o=(c,h)=>{const u=t.createShader(h);if(t.shaderSource(u,c),t.compileShader(u),!t.getShaderParameter(u,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(u));return u},s=`
      attribute vec2 a_position;
      varying vec2 pos;
      void main() {
        pos = a_position;
        gl_Position = vec4(a_position, 0, 1);
      }`,l=`
precision mediump float;
varying vec2 pos;
${Array.from(this.uniforms.values()).map(c=>`uniform ${c.dtype} ${c.name};`).join(`
`)}

void main() {
  ${Array.from(this.varmap.values()).map(c=>`${c.dtype} ${c.name} = ${c.gen()};`).join(`
  `)}
  gl_FragColor = ${this.graph.gen()};
}`,a=o(s,t.VERTEX_SHADER),d=o(l,t.FRAGMENT_SHADER),m=t.createProgram();if(t.attachShader(m,a),t.attachShader(m,d),t.linkProgram(m),!t.getProgramParameter(m,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(m));t.useProgram(m);const I=t.getAttribLocation(m,"a_position"),k=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,k),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),t.STATIC_DRAW),t.enableVertexAttribArray(I),t.vertexAttribPointer(I,2,t.FLOAT,!1,0,0),console.log(this.uniforms),this.uniforms.forEach(c=>{const h=t.getUniformLocation(m,c.name);c.setValue=(...u)=>{c.dtype==p?t.uniform1f(h,...u):c.dtype==z?t.uniform2f(h,...u):c.dtype==N?t.uniform3f(h,...u):t.uniform4f(h,...u)}})}}render(){this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}}const E=Y("canvas","","",{id:"glcanvas"});document.body.appendChild(E);E.width=500;E.height=500;const j=n=>n.x().pow(2).add(n.y().pow(2)).pow(.5),ee=(n,e,r)=>(n=n.clamp(0,1),e.mul(te.sub(n)).add(r.mul(n))),te=new A(1),P=new R,D=new R;let q=x.x().atan(x.y().mul(-1)),F=j(x).log().mul(-1),ne=q.add(D.mul(.5)).mul(5).sin().mul(F.mul(5).add(P.mul(5)).sin()).clamp(0,1),T=g([1,3,6]).add(P.mul(2)).add(F.mul(.1)).sin().mul(ne),re=g([F,q]);const oe=j(re.sub(g([.5,0]))).mul(-8).add(2).clamp(0,1);T=ee(oe,T,g([1,0,0]));const se=new Z(g([T,1]),E);let $=0;const w=new Map;document.body.addEventListener("keydown",n=>{w.set(n.key,!0)});document.body.addEventListener("keyup",n=>{w.set(n.key,!1)});let C=0,L=1,M=0;function G(n){var r,t,o;let e=C-n;C=n,(r=w.get("ArrowUp"))!=null&&r&&(L+=.2),L*=.95,M+=e*(L+1),(t=w.get("ArrowLeft"))!=null&&t?$+=.1:(o=w.get("ArrowRight"))!=null&&o&&($-=.1),P.setValue(-M*.001),D.setValue($),se.render(),requestAnimationFrame(G)}requestAnimationFrame(G);
