var K=Object.defineProperty;var W=(t,e,o)=>e in t?K(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o;var A=(t,e,o)=>(W(t,typeof e!="symbol"?e+"":e,o),o);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function o(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerpolicy&&(r.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?r.credentials="include":n.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=o(n);fetch(n.href,r)}})();const X=(t,e,o,s)=>{const n=document.createElement(t);return n.innerText=e,o&&n.classList.add(...o.split(".").filter(r=>r)),s&&Object.entries(s).forEach(([r,i])=>{r==="children"?i.forEach(u=>n.appendChild(u)):r==="eventListeners"?Object.entries(i).forEach(([u,p])=>{n.addEventListener(u,p)}):r==="color"||r==="background"?n.style[r]=i:n[r]=i}),n},O=(t,e=null)=>{if(e==null&&(e=w(t)),typeof t=="number"&&(t={op:"const",value:t,vectype:1,srcs:[]}),t.vectype==e)return t;if(t.vectype!=1)throw new Error("upcast not implemented for dtype "+e);return{op:"vec",srcs:Array.from({length:e},()=>t),vectype:e}},w=t=>typeof t=="number"?1:t.vectype,L=t=>{const e=Math.max(...t.map(w));return{srcs:t.map(o=>O(o,e)),vectype:e}},b=t=>e=>({op:t,...L([e])}),v=t=>(e,o)=>({op:t,...L([e,o])}),J=t=>(e,o,s)=>({op:t,...L([e,o,s])}),Q=(...t)=>{let e=t.map(s=>O(s));if(e.length==1)return e[0];let o=e.reduce((s,n)=>s+w(n),0);if(isNaN(o))throw new Error("vec can only have 4 arguments");if(o>4)throw new Error("vec can only have 4 arguments");return{op:"vec",srcs:e,vectype:o}},h=(t,e)=>{if(w(e)<=t)throw new Error(`index ${t} out of bounds for vec size ${w(e)}`);return{op:"index",srcs:L([e]).srcs,value:t,vectype:1}},Z=b("sin"),_=b("cos"),V=b("tan"),ee=b("log"),C=b("exp"),P=v("add"),j=v("sub"),R=v("mul"),x=v("div"),z=v("pow"),te=v("atan"),re=J("clamp"),M=t=>z(t,.5),U=t=>{let e=h(0,t);for(let o=1;o<w(t);o++)e=P(e,h(o,t));return e},q=t=>M(U(R(t,t))),ne=t=>x(t,q(t)),se=t=>j(x(2,P(1,C(R(t,-2)))),1),l=t=>t instanceof a?t.ast:t;class a{constructor(...e){A(this,"ast");A(this,"vectype");if(this.ast=Q(...e.map(l)),isNaN(this.ast.vectype))throw new Error("vector must have 1,2,3 or 4 components");if(this.ast.vectype==null)throw new Error("vector must have 1,2,3 or 4 components");this.vectype=this.ast.vectype}sin(){return new a(Z(this.ast))}cos(){return new a(_(this.ast))}tan(){return new a(V(this.ast))}log(){return new a(ee(this.ast))}exp(){return new a(C(this.ast))}add(e){return new a(P(this.ast,l(e)))}sub(e){return new a(j(this.ast,l(e)))}mul(e){return new a(R(this.ast,l(e)))}div(e){return new a(x(this.ast,l(e)))}pow(e){return new a(z(this.ast,l(e)))}atan(e){return new a(te(this.ast,l(e)))}clamp(e,o){return new a(re(this.ast,l(e),l(o)))}x(){return new a(h(0,this.ast))}y(){return new a(h(1,this.ast))}z(){return new a(h(2,this.ast))}w(){return new a(h(3,this.ast))}length(){return new a(q(this.ast))}normalize(){return new a(ne(this.ast))}sum(){return new a(U(this.ast))}sqrt(){return new a(M(this.ast))}tanh(){return new a(se(this.ast))}}const oe=t=>{const e=new Map,o=[];function s(n){if(e.has(n)){let p=e.get(n);return p.usecount+=1,p}const r=n.srcs.map(s),i=n.op=="varying"?n.name:"x"+o.length,u={ast:n,srcs:r,name:i,usecount:1};return o.push(u),e.set(n,u),u}return s(t),o},ae=t=>{function e(s){return s.ast.op=="const"?o(s):s.usecount>1?s.name:o(s)}function o(s){const n=s.ast.op;if(n=="uniform"||n=="varying")return s.name;if(n=="const"){let r=s.ast.value.toString();return r.includes(".")||(r+=".0"),r}return n=="vec"?`vec${s.ast.vectype}(${s.srcs.map(r=>e(r)).join(",")})`:n=="index"?`${e(s.srcs[0])}.${["x","y","z","w"][s.ast.value]}`:n=="add"?`( ${e(s.srcs[0])} + ${e(s.srcs[1])})`:n=="sub"?`(${e(s.srcs[0])} - ${e(s.srcs[1])})`:n=="mul"?`(${e(s.srcs[0])} * ${e(s.srcs[1])})`:n=="div"?`(${e(s.srcs[0])} / ${e(s.srcs[1])})`:`${n}(${s.srcs.map(r=>e(r)).join(", ")})`}return t.map(s=>["uniform","varying","const"].includes(s.ast.op)||s.usecount==1?"":`${["float","vec2","vec3","vec4"][s.ast.vectype-1]} ${s.name} = ${o(s)};
`).join("")+"gl_FragColor = "+o(t[t.length-1])};class S extends a{constructor(e){super({op:"uniform",vectype:e,srcs:[],setValue:(...o)=>{}})}setValue(...e){this.ast.setValue(...e)}}const ie=(t,e)=>new a({op:"varying",name:t,vectype:e,srcs:[]}),$=ie("pos",2),ce=new S(1);let ue=new a(1,2,3,4);ue.sum().add($).add(ce);class le{constructor(e,o){A(this,"gl");if(e.vectype<3)throw new Error("graph must result in vec3 got "+e.vectype);e.vectype==3&&(e=new a(e,1));const s=oe(e.ast),n=s.filter(r=>r.ast.op=="uniform");{const r=o.getContext("webgl2");if(!r)throw new Error("webgl not suppported");this.gl=r;const i=(m,d)=>{const c=r.createShader(d);if(r.shaderSource(c,m),r.compileShader(c),!r.getShaderParameter(c,r.COMPILE_STATUS))throw new Error(r.getShaderInfoLog(c));return c},u=`
      attribute vec2 a_position;
      varying vec2 pos;
      void main() {
        pos = a_position;
        gl_Position = vec4(a_position, 0, 1);
      }`,p=`
precision mediump float;
varying vec2 pos;
${n.map(m=>`uniform ${["float","vec2","vec3","vec4"][m.ast.vectype-1]} ${m.name};`).join(`
`)}

void main() {

${ae(s)};

}`;console.log(p);const G=i(u,r.VERTEX_SHADER),Y=i(p,r.FRAGMENT_SHADER),f=r.createProgram();if(r.attachShader(f,G),r.attachShader(f,Y),r.linkProgram(f),!r.getProgramParameter(f,r.LINK_STATUS))throw new Error(r.getProgramInfoLog(f));r.useProgram(f);const T=r.getAttribLocation(f,"a_position"),H=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,H),r.bufferData(r.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),r.STATIC_DRAW),r.enableVertexAttribArray(T),r.vertexAttribPointer(T,2,r.FLOAT,!1,0,0),n.forEach(m=>{const d=m.ast,c=r.getUniformLocation(f,m.name);d.setValue=(...E)=>{d.vectype==1?r.uniform1f(c,...E):d.vectype==2?r.uniform2f(c,...E):d.vectype==3?r.uniform3f(c,...E):r.uniform4f(c,...E)}})}}render(){this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}}function fe(t){const e=X("canvas","","",{class:"glcanvas"});return e.width=500,e.height=500,document.body.appendChild(e),new le(t,e)}let g=new S(1),B=new S(1),D=new S(1),pe=$.length(),me=$.x().atan($.y()).add(B);g.mul(5).sin().mul(.2);let de=me.mul(10).sin(),he=pe.log().sub(D).mul(10).sin(),we=de.mul(he),ve=new a(g,g.add(2),g.add(4)).sin(),ge=fe(ve.mul(we));const y=new Map;document.addEventListener("keydown",t=>{y.set(t.key,!0)});document.addEventListener("keyup",t=>{y.set(t.key,!1)});let F=0,N=0,I=0;function k(t){var n,r,i;t=t*.001;let e=t-I;I=t;let o=((n=y.get("ArrowRight"))!=null&&n?1:0)-((r=y.get("ArrowLeft"))!=null&&r?1:0),s=(i=y.get("ArrowUp"))!=null&&i?2:1;F+=e*o*2,N+=e*s,B.setValue(F),D.setValue(N),g.setValue(t),ge.render(),requestAnimationFrame(k)}k(0);
